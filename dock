#!/bin/bash

# Docker helper script for GC Scaffold
# Usage: dock [command] [options]

set -e

COMPOSE_FILE="docker-compose.yml"
COMPOSE_PROD_FILE="docker-compose.prod.yml"
PROJECT_NAME="gc-scaffold"
DEV_SERVICE="app-dev"
PROD_SERVICE="app-prod"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Stop containers
stop_containers() {
    log_info "Stopping containers..."
    docker-compose -f "$COMPOSE_FILE" down 2>/dev/null || true
    docker-compose -f "$COMPOSE_PROD_FILE" down 2>/dev/null || true
}

# Check if container is running
is_running() {
    local service=$1
    local compose_file=$2
    docker-compose -f "$compose_file" ps "$service" | grep -q "Up" 2>/dev/null
}

# Main commands
cmd_dev() {
    local clear_cache=false
    
    # Check for --clear-cache flag
    if [[ "$1" == "--clear-cache" ]]; then
        clear_cache=true
    fi
    
    log_info "Starting development environment..."
    
    # Stop any running containers
    stop_containers
    
    # Clear cache if requested
    if [[ "$clear_cache" == true ]]; then
        log_info "Clearing Docker cache..."
        docker system prune -f
    fi
    
    # Build and start dev container
    log_info "Building and starting dev container..."
    docker-compose -f "$COMPOSE_FILE" up --build
}

cmd_rebuild() {
    log_info "Rebuilding containers..."
    
    stop_containers
    
    log_info "Removing old images..."
    docker-compose -f "$COMPOSE_FILE" down --rmi local 2>/dev/null || true
    docker-compose -f "$COMPOSE_PROD_FILE" down --rmi local 2>/dev/null || true
    
    log_info "Rebuilding from scratch..."
    docker-compose -f "$COMPOSE_FILE" build --no-cache
    docker-compose -f "$COMPOSE_PROD_FILE" build --no-cache
    
    log_info "Rebuild complete!"
}

cmd_stop() {
    log_info "Stopping all containers..."
    stop_containers
    log_info "All containers stopped."
}

cmd_detached() {
    log_info "Starting development environment in detached mode..."
    
    stop_containers
    
    docker-compose -f "$COMPOSE_FILE" up --build -d
    
    log_info "Container started in detached mode."
    log_info "Use 'dock logs' to view logs or 'dock status' to check status."
}

cmd_prod() {
    log_info "Starting production environment..."
    
    stop_containers
    
    log_info "Building production container..."
    docker-compose -f "$COMPOSE_PROD_FILE" up --build
}

cmd_prune() {
    log_warn "This will remove stopped containers and unused images."
    read -p "Are you sure? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "Pruning Docker system..."
        docker system prune -af
        log_info "Prune complete!"
    else
        log_info "Prune cancelled."
    fi
}

cmd_status() {
    log_info "Container Status:"
    echo ""
    
    echo "Development:"
    if is_running "$DEV_SERVICE" "$COMPOSE_FILE"; then
        echo -e "  Status: ${GREEN}Running${NC}"
        docker-compose -f "$COMPOSE_FILE" ps "$DEV_SERVICE"
    else
        echo -e "  Status: ${RED}Stopped${NC}"
    fi
    
    echo ""
    echo "Production:"
    if is_running "$PROD_SERVICE" "$COMPOSE_PROD_FILE"; then
        echo -e "  Status: ${GREEN}Running${NC}"
        docker-compose -f "$COMPOSE_PROD_FILE" ps "$PROD_SERVICE"
    else
        echo -e "  Status: ${RED}Stopped${NC}"
    fi
    
    echo ""
    log_info "Port Mappings:"
    docker ps --filter "name=$PROJECT_NAME" --format "table {{.Names}}\t{{.Ports}}" 2>/dev/null || echo "  No containers running"
    
    echo ""
    log_info "Resource Usage:"
    docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker ps -q --filter "name=$PROJECT_NAME") 2>/dev/null || echo "  No containers running"
}

cmd_shell() {
    local service=$DEV_SERVICE
    local compose_file=$COMPOSE_FILE
    
    # Check if production is running
    if is_running "$PROD_SERVICE" "$COMPOSE_PROD_FILE"; then
        service=$PROD_SERVICE
        compose_file=$COMPOSE_PROD_FILE
        log_info "Opening shell in production container..."
    elif is_running "$DEV_SERVICE" "$COMPOSE_FILE"; then
        log_info "Opening shell in development container..."
    else
        log_error "No containers are running!"
        log_info "Start a container first with 'dock dev' or 'dock prod'"
        exit 1
    fi
    
    docker-compose -f "$compose_file" exec "$service" /bin/sh
}

cmd_logs() {
    local service=""
    local compose_file=$COMPOSE_FILE
    
    # Check for service argument
    if [[ -n "$1" ]]; then
        service="$1"
    fi
    
    # Determine which compose file to use
    if is_running "$PROD_SERVICE" "$COMPOSE_PROD_FILE"; then
        compose_file=$COMPOSE_PROD_FILE
        if [[ -z "$service" ]]; then
            service=$PROD_SERVICE
        fi
    elif is_running "$DEV_SERVICE" "$COMPOSE_FILE"; then
        if [[ -z "$service" ]]; then
            service=$DEV_SERVICE
        fi
    else
        log_error "No containers are running!"
        exit 1
    fi
    
    log_info "Following logs for $service..."
    docker-compose -f "$compose_file" logs -f "$service"
}

cmd_help() {
    echo "GC Scaffold Docker Helper"
    echo ""
    echo "Usage: dock [command] [options]"
    echo ""
    echo "Commands:"
    echo "  dev [--clear-cache]    Start development container with live reload"
    echo "  rebuild                Force rebuild all containers from scratch"
    echo "  stop                   Stop all containers"
    echo "  detached               Start dev container in detached mode"
    echo "  prod                   Start production container"
    echo "  prune                  Remove stopped containers and unused images"
    echo "  status                 Show container status and resource usage"
    echo "  shell                  Open shell in running container"
    echo "  logs [service]         Follow container logs (optionally for specific service)"
    echo "  help                   Show this help message"
    echo ""
}

# Main command dispatcher
case "${1:-help}" in
    dev)
        cmd_dev "$2"
        ;;
    rebuild)
        cmd_rebuild
        ;;
    stop)
        cmd_stop
        ;;
    detached)
        cmd_detached
        ;;
    prod)
        cmd_prod
        ;;
    prune)
        cmd_prune
        ;;
    status)
        cmd_status
        ;;
    shell)
        cmd_shell
        ;;
    logs)
        cmd_logs "$2"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac

